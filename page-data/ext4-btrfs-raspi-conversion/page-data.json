{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/ext4-btrfs-raspi-conversion",
    "result": {"data":{"post":{"excerpt":"Many guides already exist for configuring a raspberry pi root partition to use btrfs, however there were a few circumstances that basicallyâ€¦","body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Converting the Raspberry Pi rootfs to RAID1 btrfs on Ubuntu 20.04\",\n  \"slug\": \"ext4-btrfs-raspi-conversion\",\n  \"date\": \"2020-06-28T00:00:00.000Z\",\n  \"language\": \"en\",\n  \"cover\": \"./spirit_of_java_by_meganerid.jpg\",\n  \"generate-card\": true,\n  \"imageShare\": \"./social-media-card-generator-share.png\",\n  \"tags\": [\"gatsby\", \"ubuntu\", \"btrfs\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Many guides already exist for configuring a raspberry pi root partition to use btrfs, however there were a few circumstances that basically invalidated all of them:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"I wanted the raspberry pi to run Ubuntu 18.04, both for the 64-bit OS and default btrfs implementation,\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"The ubuntu image for the pi4 has royally messed with the default /boot volume, and..\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"I had to do this all on my Windows laptop, or the pi itself through ssh. \")), mdx(\"p\", null, \"If for some crazy reason your situation mirrors my own, I hope you find this documentation useful. Feel free to comment below if you have suggestions or improvements to the way I did things \\uD83D\\uDE0A\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Formatting the SD card\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"I used \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.balena.io/etcher/\"\n  }, \"balenaEtcher\"), \" to flash the latest pi4-compatible \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://ubuntu.com/download/raspberry-pi\"\n  }, \"Ubuntu 20.04 64-bit image\"), \" onto the card. Or, if you\\u2019d prefer an older release: \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"http://cdimage.ubuntu.com/ubuntu/releases/18.04.5/release/\"\n  }, \"Ubuntu 18.04 and older\"), \" (for a good description of hard vs. soft float, see \", mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://www.raspberrypi.org/forums/viewtopic.php?t=11177\"\n  }, \"Raspberry Pi Forums\"), \". In short, the hard float image will increase your performance by using the pi\\u2019s native hardware abilities.)\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Etcher automatically unmounts the card after it\\u2019s finished, so re-mount and use Disk Management (Windows search bar: \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"diskmgmt.msc\"), \", choose \\u201CRun as Administrator\\u201D) to create \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"two\"), \" partitions. The first should be the current root partition size (unexpanded) + whatever space you\\u2019d like to add. The second must be formatted \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"without\"), \" Quick Format, and use all remaining space on the volume. This will take a while.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Once you\\u2019ve created both partitions, delete the first so that the space shows \\u201Cunallocated\\u201D. This will let the pi expand it\\u2019s root partition up to your second placeholder partition. When done, it should look as below: \", mdx(\"img\", {\n    parentName: \"li\",\n    \"src\": \"./formatted.png\",\n    \"alt\": \"Formatted Drive\"\n  })), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Before ejecting the SD card, create a blank file named \\u201Cssh\\u201D in the boot partition (the only one that will mount on Windows), and remove the extension. This allows us to ssh into the pi on first boot.\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Starting up the pi\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Login to the new raspberry pi. I usually check the router to see what DHCP address it was assigned, do as you like. SSH with \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"ubuntu@X.X.X.X\"), \", password is also \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"ubuntu\"), \" and will need to be changed.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"em\", {\n    parentName: \"li\"\n  }, \"ENABLE SSH SERVICE\"), \", or get locked out the first time you mess up: \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo systemctl enable ssh\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Check that the your btrfs kernel module is enabled: \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo lsmod | grep \\\"^btrfs\\\"\"), \", if you get nothing back then \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo modprobe btrfs\"), \".\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"If need be, run a \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo apt update && sudo apt install btrfs-tools\"), \", but you should already have them on the system. If you run the command anyways, you\\u2019ll change the package to manually installed.\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Configure Partitions\")), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo fdisk /dev/mmcblk0\"), \", then enter \\u201Cp\\u201D to print the existing partitions. If you\\u2019ve followed everything up to now, you should see something similar to what\\u2019s below:\")), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"Device         Boot    Start      End  Sectors  Size Id Type\\n/dev/mmcblk0p1 *        2048   526335   524288  256M  c W95 FAT32 (LBA)\\n/dev/mmcblk0p2        526336 10508287  9981952  4.8G 83 Linux\\n/dev/mmcblk0p3      10508288 62521343 52013056 24.8G  f W95 Ext'd (LBA)\\n/dev/mmcblk0p5      10510336 62521343 52011008 24.8G  7 HPFS/NTFS/exFAT\"))), mdx(\"ol\", {\n    \"start\": 2\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Take note of the start block for the root partition (mmcblk0p2), because we\\u2019re about to delete and re-create everything except the boot. This should be fine as long as the starting sector remains unchanged.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"continue to delete (\\u201Cd\\u201D is the command) until only partition 1 (mmcblk0p1) is left.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create two new partitions with the \\u201Cn\\u201D command. Select \\u201Cp\\u201D for primary, and make sure the first \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"starts\"), \" at the exact same sector as it did before, but for size let\\u2019s increase to slightly less than 1/2 of the space left. Do this by entering \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"+14G\"), \", where the 14 is roughly your total space in Gigabytes divided by two minus one. It will ask if you want to delete the ext4 signature, select \\u201CN\\u201D.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Create a second partition the same way, using defaults and starting at the sector just after your second partition. Ensure they are exactly the same size (i.e. +14G and +14G, or whatever you chose)\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Check that all your commands executed as expected with \\u201Cp\\u201D again, and you should now have this:\")), mdx(\"div\", {\n    \"className\": \"gatsby-highlight\",\n    \"data-language\": \"text\"\n  }, mdx(\"pre\", {\n    parentName: \"div\",\n    \"className\": \"language-text\"\n  }, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-text\"\n  }, \"Device         Boot    Start      End  Sectors  Size Id Type\\n/dev/mmcblk0p1 *        2048   526335   524288  256M  c W95 FAT32 (LBA)\\n/dev/mmcblk0p2        526336 29886463 29360128   14G 83 Linux\\n/dev/mmcblk0p3      29886464 59246591 29360128   14G 83 Linux\"))), mdx(\"ol\", {\n    \"start\": 7\n  }, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Write your changes and exit with \\u201Cw\\u201D.\")), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"BTRFS Setup\")), mdx(\"p\", null, \"Enter the following commands in order: \"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo mkfs.btrfs /dev/mmcblk0p3\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo mkdir /mnt/p3\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo mount /dev/mmcblk0p3 /mnt/p3\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo rsync -qaHAXS --exclude={\\\"/dev/*\\\",\\\"/proc/*\\\",\\\"/sys/*\\\",\\\"/tmp/*\\\",\\\"/run/*\\\",\\\"/mnt/*\\\",\\\"/media/*\\\",\\\"/lost+found\\\",\\\"boot/firmware/*\\\"} / /mnt/p3\"), \" (you may want to run this command in \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"screen\"), \", in case you get disconnected)\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo lsblk -f\"), \" - take from this the \", mdx(\"em\", {\n    parentName: \"li\"\n  }, \"UUID\"), \" of mmcblk0p3, this is what you will use in the below commands instead of my value.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo nano /boot/firmware/nobtcmd.txt\"), \" (or \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"cmdline.txt\"), \", depending on your version), then edit these two values to match: \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"root=UUID=520bcef5-5b86-4e6e-a0e7-e271db19a88d rootfstype=btrfs\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo nano /etc/fstab\"), \", again changing the following line: \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"UUID=520bcef5-5b86-4e6e-a0e7-e271db19a88d       /        btrfs  defaults,noatime\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Perform one last \", mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"rsync\"), \" exactly like in step 4, to capture the above changes.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo reboot\"), \" - your device will close connection here, if you completed all the steps correctly you should be able to ssh back in within ~2 mins.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo lsblk -f\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo btrfs device add -f /dev/mmcblk0p2 /\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo lsblk -f\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo btrfs balance start -mconvert=raid1 /\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"code\", {\n    parentName: \"li\",\n    \"className\": \"language-text\"\n  }, \"sudo btrfs balance start -dconvert=raid1 /\"))), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"Long-Term Stability\"), \"\\nClone and install \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://github.com/kdave/btrfsmaintenance.git\"\n  }, \"btrfs maintenance\"), \".\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"\\uD83D\\uDCA1Quick tip:\"), \" do NOT use a swap file on root!!!\"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"Converting the Raspberry Pi rootfs to RAID1 btrfs on Ubuntu 20.04","date":"2020-06-28T00:00:00.000Z","slug":"ext4-btrfs-raspi-conversion","language":"en","tags":["gatsby","ubuntu","btrfs"],"cover":{"publicURL":"/static/b0da2248b1bc007273f727c44ff9c9cf/spirit_of_java_by_meganerid.jpg"},"imageShare":null,"translations":null}}},"pageContext":{"slug":"ext4-btrfs-raspi-conversion","previous":{"fileAbsolutePath":"/home/jovyan/content/posts/2020-06-27-writing-this-blog/index.mdx","frontmatter":{"title":"Writing a Gatsby Blog","slug":"writing-this-blog","tags":["gatsby","mdx"],"language":"en","cover":{"publicURL":"/static/c693e48107bdb95776bf655b4deae751/15300-star-map.jpg"},"unlisted":null},"timeToRead":1,"excerpt":"This post serves both to help others duplicate my work, and remind me how I did it myself, if ever I forget. At the bottom I'll probablyâ€¦"},"next":{"fileAbsolutePath":"/home/jovyan/content/posts/2020-07-10-nftables-cloudflare-secure/index.mdx","frontmatter":{"title":"Securing Your Website with nftables and Cloudflare","slug":"nftables-cloudflare-secure","tags":["nftables","firewall","cloudflare","security"],"language":"en","cover":null,"unlisted":null},"timeToRead":1,"excerpt":"nftables is still fairly new, fairly tricky to the uninitiated, and fairly  not present  on StackExchange sites... Since nothing I host everâ€¦"}}},
    "staticQueryHashes": ["1956263691","4156811642"]}